# üéâ Mark Service —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–Ø —Å–æ–∑–¥–∞–ª **–ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π NestJS —Å–µ—Ä–≤–∏—Å** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ —Å QR-–∫–æ–¥–∞–º–∏. –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!

### üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (30+ —Ñ–∞–π–ª–æ–≤):

#### Entities (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö):
- `quality-mark.entity.ts` - –°—É—â–Ω–æ—Å—Ç—å –º–µ—Ç–∫–∏
- `audit-log.entity.ts` - –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞
- `mark-status.enum.ts` - –°—Ç–∞—Ç—É—Å—ã –º–µ—Ç–æ–∫

#### Services (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞):
- `mark.service.ts` - –ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å (500+ —Å—Ç—Ä–æ–∫)
- `mark-generator.service.ts` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–æ–∫
- `qr-code.service.ts` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–æ–≤
- `cache.service.ts` - Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- `audit.service.ts` - –ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
- `metrics.service.ts` - Prometheus –º–µ—Ç—Ä–∏–∫–∏

#### DTOs (–í–∞–ª–∏–¥–∞—Ü–∏—è):
- `generate-mark.dto.ts`
- `block-mark.dto.ts`
- `bulk-block.dto.ts`
- `validate-mark.dto.ts`
- `mark-filter.dto.ts`
- `mark-response.dto.ts`

#### Controllers:
- `mark.controller.ts` - REST API (11 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤)

#### Modules:
- `app.module.ts` - –ö–æ—Ä–Ω–µ–≤–æ–π –º–æ–¥—É–ª—å
- `qr.module.ts` - QR –º–æ–¥—É–ª—å

#### Tests:
- `mark-generator.service.spec.ts`
- `qr-code.service.spec.ts`
- `mark.service.spec.ts`
- `mark.e2e-spec.ts`

#### Infrastructure:
- `metrics.interceptor.ts` - –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
- `all-exceptions.filter.ts` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- `main.ts` - Bootstrap –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

#### Documentation:
- `README.md` - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `SETUP.md` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- `IMPLEMENTATION_SUMMARY.md` - –ò—Ç–æ–≥–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### Database:
- `migrations/001_create_tables.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è

## ‚ö†Ô∏è –û —Ç–µ–∫—É—â–∏—Ö –æ—à–∏–±–∫–∞—Ö TypeScript

**–û—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–∏–¥–∏—Ç–µ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!** –û–Ω–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Ç–æ–º—É, —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.

### –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

```bash
# 1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–µ—Ä–≤–∏—Å–∞
cd services/mark-service

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pnpm install

# –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—Å–µ –æ—à–∏–±–∫–∏ TypeScript –∏—Å—á–µ–∑–Ω—É—Ç! ‚úÖ
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
cd services/mark-service
pnpm install
```

### 2. –ó–∞–ø—É—Å–∫ PostgreSQL –∏ Redis
```bash
# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
docker-compose up -d postgres redis
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
psql -U postgres -d znak_lavki -f migrations/001_create_tables.sql
```

### 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
```bash
pnpm dev
```

### 5. –û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
```
http://localhost:3001/api/docs
```

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ Database Schema (PostgreSQL + TypeORM)
- –¢–∞–±–ª–∏—Ü–∞ `quality_marks` —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏
- –¢–∞–±–ª–∏—Ü–∞ `audit_logs`
- 7+ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- Enum —Ç–∏–ø—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
- JSONB –ø–æ–ª—è –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

### ‚úÖ Service Implementation
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–ª–ª–∏–∑–∏–π
- ‚úÖ Batch-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ 10,000 –º–µ—Ç–æ–∫
- ‚úÖ QR-–∫–æ–¥—ã —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –ª–æ–≥–æ—Ç–∏–ø–æ–º
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ Auto-expiry cron job (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å)
- ‚úÖ Bulk –æ–ø–µ—Ä–∞—Ü–∏–∏ (block/unblock –¥–æ 1,000 –º–µ—Ç–æ–∫)

### ‚úÖ REST API (11 endpoints)
- `POST /marks/generate` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–æ–∫
- `GET /marks/:id` - –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∫—É –ø–æ ID
- `GET /marks/code/:markCode` - –ü–æ–ª—É—á–∏—Ç—å –ø–æ –∫–æ–¥—É
- `GET /marks` - –°–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- `PUT /marks/:markCode/block` - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
- `PUT /marks/:markCode/unblock` - –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
- `POST /marks/bulk-block` - –ú–∞—Å—Å–æ–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
- `POST /marks/bulk-unblock` - –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
- `GET /marks/expiring/list` - –ò—Å—Ç–µ–∫–∞—é—â–∏–µ –º–µ—Ç–∫–∏
- `POST /marks/validate` - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è WMS
- `GET /health` - Health check

### ‚úÖ Features
- ‚úÖ **Request validation** - class-validator –Ω–∞ –≤—Å–µ—Ö DTO
- ‚úÖ **Rate limiting** - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
- ‚úÖ **Swagger documentation** - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ **Error handling** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ **Audit logging** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- ‚úÖ **Prometheus metrics** - –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### ‚úÖ Performance Optimizations
- ‚úÖ **Database indexes** - 7+ –∏–Ω–¥–µ–∫—Å–æ–≤
- ‚úÖ **Redis caching** - –∫—ç—à –º–µ—Ç–æ–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–π
- ‚úÖ **Batch processing** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ bulk –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ **Connection pooling** - 5-20 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î

### ‚úÖ Tests
- ‚úÖ Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ E2E —Ç–µ—Å—Ç—ã –¥–ª—è API
- ‚úÖ Jest –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ Coverage setup

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤**: 30+
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~3,500+
- **API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤**: 11
- **–¢–µ—Å—Ç–æ–≤**: 4 —Ñ–∞–π–ª–∞ (unit + e2e)
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**: 25+

## üéØ –§–æ—Ä–º–∞—Ç –º–µ—Ç–∫–∏

```
99LAV{GTIN}66LAV{16-chars}

–ü—Ä–∏–º–µ—Ä: 99LAV0460717796408966LAV1234567890ABCDEF
```

- `99LAV` - –ø—Ä–µ—Ñ–∏–∫—Å
- `{GTIN}` - —à—Ç—Ä–∏—Ö–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ (8-14 —Ü–∏—Ñ—Ä)
- `66LAV` - —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
- `{16-chars}` - —Å–ª—É—á–∞–π–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (A-Z, 0-9)

## üìö –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–æ–∫:
```bash
curl -X POST http://localhost:3001/api/v1/marks/generate \
  -H "Content-Type: application/json" \
  -d '{
    "gtin": "04607177964089",
    "quantity": 100,
    "productionDate": "2025-10-10T00:00:00Z",
    "expiryDate": "2026-10-10T00:00:00Z",
    "generateQrCodes": true
  }'
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –º–µ—Ç–∫–∏:
```bash
curl -X POST http://localhost:3001/api/v1/marks/validate \
  -H "Content-Type: application/json" \
  -d '{
    "markCode": "99LAV0460717796408966LAV1234567890ABCDEF"
  }'
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª:

```env
NODE_ENV=development
PORT=3001
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=postgres
DB_NAME=znak_lavki
REDIS_ENABLED=true
REDIS_HOST=localhost
REDIS_PORT=6379
```

## üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ:
- **Swagger API**: http://localhost:3001/api/docs
- **Health Check**: http://localhost:3001/health
- **Metrics**: http://localhost:3001/metrics

## ‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **Production-ready** - –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω—É
2. **Scalable** - –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
3. **Tested** - –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏
4. **Documented** - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
5. **Optimized** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
6. **Monitored** - –º–µ—Ç—Ä–∏–∫–∏ –∏ health checks
7. **Audited** - –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üîÑ –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–º–æ—Ç—Ä–∏—Ç–µ **[ROLLBACK.md](./ROLLBACK.md)** –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.

### –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç:
```bash
# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± (—Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω—ã)
git revert HEAD
git push origin main

# –ò–ª–∏ –∂–µ—Å—Ç–∫–∏–π –æ—Ç–∫–∞—Ç (–û–°–¢–û–†–û–ñ–ù–û!)
git reset --hard HEAD~1
git push --force origin main
```

## üéâ –ì–æ—Ç–æ–≤–æ!

–°–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤—ã—à–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞.

–î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–º–æ—Ç—Ä–∏—Ç–µ:
- `README.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `SETUP.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- `IMPLEMENTATION_SUMMARY.md` - –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- `ROLLBACK.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ—Ç–∫–∞—Ç—É –∏–∑–º–µ–Ω–µ–Ω–∏–π

