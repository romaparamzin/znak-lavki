# ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ó–∞–ø—É—â–µ–Ω

## üéâ –°—Ç–∞—Ç—É—Å –ó–∞–ø—É—Å–∫–∞

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–∞ –∏ –∑–∞–ø—É—â–µ–Ω–∞!

### ‚úÖ –ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –°–µ—Ä–≤–∏—Å—ã

| –°–µ—Ä–≤–∏—Å              | –°—Ç–∞—Ç—É—Å        | URL                           | –û–ø–∏—Å–∞–Ω–∏–µ                |
| ------------------- | ------------- | ----------------------------- | ----------------------- |
| **Grafana**         | ‚úÖ UP         | http://localhost:3000         | –î–∞—à–±–æ—Ä–¥—ã –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è |
| **Prometheus**      | ‚úÖ UP         | http://localhost:9090         | –°–±–æ—Ä –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫  |
| **Loki**            | ‚úÖ UP         | http://localhost:3100         | –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ª–æ–≥–æ–≤         |
| **cAdvisor**        | ‚úÖ UP         | http://localhost:8080         | –ú–µ—Ç—Ä–∏–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤     |
| **Postgres Export** | ‚úÖ UP         | http://localhost:9187/metrics | –ú–µ—Ç—Ä–∏–∫–∏ PostgreSQL      |
| **Redis Exporter**  | ‚úÖ UP         | http://localhost:9121/metrics | –ú–µ—Ç—Ä–∏–∫–∏ Redis           |
| **Alertmanager**    | ‚ö†Ô∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ | http://localhost:9093         | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤   |

### ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ü—Ä–æ–±–ª–µ–º—ã

1. **Node Exporter** - –ù–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –Ω–∞ macOS (–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å Docker –Ω–∞ Mac)
   - –†–µ—à–µ–Ω–∏–µ: –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
2. **Alertmanager** - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
   - –í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: –¢—Ä–µ–±—É—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Slack/PagerDuty
   - –†–µ—à–µ–Ω–∏–µ: –†–∞–±–æ—Ç–∞–µ—Ç –≤ –±–∞–∑–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–∑–∂–µ

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –î–æ—Å—Ç—É–ø

### Grafana (–î–∞—à–±–æ—Ä–¥—ã)

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
open http://localhost:3000

# –õ–æ–≥–∏–Ω: admin
# –ü–∞—Ä–æ–ª—å: admin
```

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –î–∞—à–±–æ—Ä–¥—ã:**

1. –û–±–∑–æ—Ä –°–∏—Å—Ç–µ–º—ã
2. –ë–∏–∑–Ω–µ—Å-–ú–µ—Ç—Ä–∏–∫–∏ (IDR, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ä–æ–∫, –≤–∞–ª–∏–¥–∞—Ü–∏—è)
3. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
4. –û—à–∏–±–∫–∏
5. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### Prometheus (–ú–µ—Ç—Ä–∏–∫–∏)

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
open http://localhost:9090

# –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:
# - rate(http_requests_total[5m])
# - idr_rate{time_window="5m"}
# - mark_validation_duration_ms
```

### Mark Service (–ù–æ–≤—ã–µ Endpoint'—ã)

```bash
# –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
curl http://localhost:3000/metrics

# Health Check
curl http://localhost:3000/metrics/health
```

## üìä –ß—Ç–æ –ë—ã–ª–æ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. MetricsService - –†–∞—Å—à–∏—Ä–µ–Ω

- ‚úÖ IDR Rate (Invalid Data Rate)
- ‚úÖ –°–∫–æ—Ä–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∞—Ä–æ–∫
- ‚úÖ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ/–∏—Å—Ç–µ–∫—à–∏–µ –º–∞—Ä–∫–∏
- ‚úÖ –í—Ä–µ–º—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (histogram)
- ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ —Å–∏—Å—Ç–µ–º—ã

### 2. Structured Logging

- ‚úÖ Correlation IDs –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
- ‚úÖ JSON –ª–æ–≥–∏
- ‚úÖ Audit trail –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### 3. Prometheus Alerts

- ‚úÖ 30+ –ø—Ä–∞–≤–∏–ª –∞–ª–µ—Ä—Ç–æ–≤
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–∞–ª–µ—Ä—Ç—ã (IDR, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –≤–∞–ª–∏–¥–∞—Ü–∏—è)
- ‚úÖ –ê–ª–µ—Ä—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ê–ª–µ—Ä—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### 4. Grafana Dashboards

- ‚úÖ 5 –¥–∞—à–±–æ—Ä–¥–æ–≤
- ‚úÖ 48+ –ø–∞–Ω–µ–ª–µ–π
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –æ—à–∏–±–∫–∏

### 5. Alertmanager

- ‚úÖ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ Slack –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
- ‚úÖ PagerDuty –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)

## üîß –°–ª–µ–¥—É—é—â–∏–µ –®–∞–≥–∏

### 1. –ò–º–ø–æ—Ä—Ç –î–∞—à–±–æ—Ä–¥–æ–≤ –≤ Grafana

```bash
# –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ Grafana (http://localhost:3000)
# 1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: Dashboards ‚Üí Import
# 2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—ã–π JSON —Ñ–∞–π–ª:
#    - monitoring/grafana/dashboards/business-metrics.json
#    - monitoring/grafana/dashboards/performance.json
#    - monitoring/grafana/dashboards/errors.json
#    - monitoring/grafana/dashboards/user-activity.json
#    - monitoring/grafana/dashboards/overview.json
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ê–ª–µ—Ä—Ç–æ–≤ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ monitoring/
cat > monitoring/.env << EOF
SLACK_WEBHOOK_URL_CRITICAL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
SLACK_WEBHOOK_URL_WARNING=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
PAGERDUTY_INTEGRATION_KEY=your_pagerduty_key
EOF

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ alertmanager
docker restart alertmanager
```

### 3. –ó–∞–ø—É—Å–∫ Mark Service

```bash
cd services/mark-service

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è Node.js
source ~/.nvm/nvm.sh && nvm use 18

# –ó–∞–ø—É—Å–∫ –≤ development —Ä–µ–∂–∏–º–µ
npm run dev

# –ò–ª–∏ –≤ production —Ä–µ–∂–∏–º–µ
npm start
```

## üìà –ü—Ä–æ–≤–µ—Ä–∫–∞ –†–∞–±–æ—Ç—ã

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ú–µ—Ç—Ä–∏–∫

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç—Ä–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è
curl http://localhost:3000/metrics | grep mark_

# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# - marks_generated_total
# - mark_validation_success_total
# - idr_rate
# - active_marks_count
# –∏ –¥—Ä—É–≥–∏–µ...
```

### –¢–µ—Å—Ç 2: Prometheus Targets

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ Prometheus
open http://localhost:9090/targets

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ target mark-service UP
# (–∫–æ–≥–¥–∞ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω)
```

### –¢–µ—Å—Ç 3: Correlation ID

```bash
# –°–¥–µ–ª–∞–π—Ç–µ –∑–∞–ø—Ä–æ—Å
curl -X POST http://localhost:3000/marks/generate \
  -H "Content-Type: application/json" \
  -d '{
    "gtin": "04607177964089",
    "quantity": 10,
    "productionDate": "2025-10-10T00:00:00Z",
    "expiryDate": "2026-10-10T00:00:00Z"
  }'

# –í –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Correlation-ID

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker logs mark-service 2>&1 | grep '"type":"request"' | jq .
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ë—ã—Å—Ç—Ä—ã–π –°—Ç–∞—Ä—Ç:** `monitoring/–ë–´–°–¢–†–´–ô_–°–¢–ê–†–¢_–ú–û–ù–ò–¢–û–†–ò–ù–ì–ê.md`
- **–ü–æ–ª–Ω–æ–µ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:** `services/mark-service/MONITORING_GUIDE.md`
- **–°–≤–æ–¥–∫–∞ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** `–ú–û–ù–ò–¢–û–†–ò–ù–ì_–†–ï–ê–õ–ò–ó–ê–¶–ò–Ø.md`
- **README:** `monitoring/README_RU.md`

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### IDR Rate (Invalid Data Rate)

```promql
idr_rate{time_window="5m"}
```

- –ù–æ—Ä–º–∞: < 1%
- Warning: > 1%
- Critical: > 5%

### –°–∫–æ—Ä–æ—Å—Ç—å –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ú–∞—Ä–æ–∫

```promql
rate(marks_generated_total[5m])
```

### –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –í–∞–ª–∏–¥–∞—Ü–∏–∏

```promql
(rate(mark_validation_success_total[5m]) /
 (rate(mark_validation_success_total[5m]) +
  rate(mark_validation_failure_total[5m]))) * 100
```

- –ù–æ—Ä–º–∞: > 95%

### –í—Ä–µ–º—è –í–∞–ª–∏–¥–∞—Ü–∏–∏ (p95)

```promql
histogram_quantile(0.95,
  sum(rate(mark_validation_duration_ms_bucket[5m])) by (le))
```

- –ù–æ—Ä–º–∞: < 100ms
- Warning: > 250ms
- Critical: > 500ms

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–µ—Ä–≤–∏—Å–∞–º–∏

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
cd monitoring
docker-compose -f docker-compose.monitoring.yml down
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫

```bash
cd monitoring
docker-compose -f docker-compose.monitoring.yml restart
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –õ–æ–≥–æ–≤

```bash
# –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose -f docker-compose.monitoring.yml logs -f

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å
docker logs grafana -f
docker logs prometheus -f
docker logs alertmanager -f
```

## ‚úÖ –ß–µ–∫-–õ–∏—Å—Ç

- [x] Mark service —Å–æ–±—Ä–∞–Ω –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] Prometheus –∑–∞–ø—É—â–µ–Ω –Ω–∞ :9090
- [x] Grafana –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ :3000
- [x] Exporters –∑–∞–ø—É—â–µ–Ω—ã
- [x] –ú–µ—Ç—Ä–∏–∫–∏ endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–∞—à–±–æ—Ä–¥—ã –≤ Grafana
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã Slack/PagerDuty (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] Mark service –∑–∞–ø—É—â–µ–Ω –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏

## üéâ –ì–æ—Ç–æ–≤–æ!

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

**–û—Å–Ω–æ–≤–Ω—ã–µ URL:**

- Grafana: http://localhost:3000 (admin/admin)
- Prometheus: http://localhost:9090
- Mark Service Metrics: http://localhost:3000/metrics (–∫–æ–≥–¥–∞ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω)

–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞! üìäüöÄ
